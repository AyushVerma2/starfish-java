<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataAsset.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Starfish - Developer Toolkit for data ecosystems</a> &gt; <a href="index.source.html" class="el_package">sg.dex.starfish</a> &gt; <span class="el_source">DataAsset.java</span></div><h1>DataAsset.java</h1><pre class="source lang-java linenums">package sg.dex.starfish;

import sg.dex.crypto.Hash;
import sg.dex.starfish.constant.Constant;
import sg.dex.starfish.exception.AuthorizationException;
import sg.dex.starfish.exception.StarfishValidationException;
import sg.dex.starfish.exception.StorageException;
import sg.dex.starfish.util.Hex;
import sg.dex.starfish.util.JSON;
import sg.dex.starfish.util.ProvUtil;
import sg.dex.starfish.util.Utils;

import java.io.IOException;
import java.io.InputStream;
import java.util.Map;

/**
 * Interface representing a data asset.
 * &lt;p&gt;
 * A data asset is any asset that can be represented as an immutable sequence of bytes.
 * As such, data assets offer the following properties:
 * - They can be validated with a hash of the byte content
 * - The byte representation of the data can be obtained (subject to appropriate permissions)
 *
 * @author Mike
 * @version 0.5
 */
public interface DataAsset extends Asset {

    @Override
    default boolean isDataAsset() {
<span class="fc" id="L32">        return true;</span>
    }

    /**
     * Gets an input stream that can be used to consume the content of this asset.
     * &lt;p&gt;
     * Will throw an exception if consumption of the asset data in not possible locally.
     *
     * @return An input stream allowing consumption of the asset data
     * @throws AuthorizationException if requester does not have access permission
     * @throws StorageException       if unable to load the Asset
     */
    @Override
    InputStream getContentStream();

    /**
     * Gets the size of this data asset's content
     *
     * @return The size of the asset in bytes
     */
    long getContentSize();


    /**
     * This method is to validate the hash of the asset content .
     * it will calculate the hash of the content of an Asset
     * then compare with the hash value included in metadata,
     * if both are not the same , StarfishValidation Exception will be thrown
     *
     * @return boolean  true if the content is valid else false
     * @throws StarfishValidationException if hash content is not matched , exception will be thrown
     */
    default boolean validateContentHash() {

<span class="fc" id="L66">        Object contentHashFromMetadata = this.getMetadata().get(Constant.CONTENT_HASH);</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        if (null == contentHashFromMetadata) {</span>
<span class="nc" id="L68">            throw new StarfishValidationException(&quot;Content hash is not included in the metadata&quot;);</span>
        }

<span class="fc" id="L71">        String contentHash = Hex.toString(Hash.sha3_256(Utils.stringFromStream(this.getContentStream())));</span>
        // if hash of asset content is equal
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        if (contentHashFromMetadata.toString().equals(contentHash)) {</span>
<span class="fc" id="L74">            return true;</span>

        }
<span class="nc" id="L77">        throw new StarfishValidationException(&quot;Failed to validate content hash&quot;);</span>
    }

    /**
     * This method is used to calculate the hash of the content by using keccak256 hashing algorithm.
     *
     * @return the content of hash as string
     */

    default String getContentHash() throws IOException {

<span class="fc" id="L88">        return Hash.sha3_256String(this.getContentStream());</span>
    }



    /**
     * This method is to include the content of hash in the asset metadata.
     * Hash of the content will be calculated based on sha3_256String hashing algo , and the hash content will
     * be included in the asset metadata.
     * This hash content will be used to validate the integrity of asset content
     * Also this operation is only applicable if the Asset is of type DataAsset , if Asset is not
     * DataAsset Unsupported Operation Exception will be thrown
     *
     * @return respective data asset sub class.
     * @throws UnsupportedOperationException if the Asset type is not DataAsset
     */
    default DataAsset includeContentHash() throws IOException {

        // check if the hash content is already present also
        // validate if content is valid or not
<span class="pc bpc" id="L108" title="3 of 4 branches missed.">        if (null != this.getMetadata().get(Constant.CONTENT_HASH) &amp;&amp; validateContentHash()) {</span>

<span class="nc" id="L110">            return this;</span>

        } else {
<span class="fc" id="L113">            Map&lt;String, Object&gt; metaMap = this.getMetadata();</span>
<span class="fc" id="L114">            metaMap.put(Constant.CONTENT_HASH, getContentHash());</span>

<span class="fc" id="L116">            return updateMeta(JSON.toPrettyString(metaMap));</span>
        }
    }

    /**
     * Get the new Data Asset based on metaData passed as n argument.
     * This method will be implemented by the sub class
     *
     * @param newMetaData new meta data that will be used to create a Data Asset.
     * @return the respective dataAsset based on sub-class
     * @throws UnsupportedOperationException if this operation  is not supported by sub-class
     */
    default DataAsset updateMeta(String newMetaData) {
<span class="nc" id="L129">        throw new UnsupportedOperationException(&quot;This Operation is not supported&quot;);</span>
    }

    /**
     * This method is to include the include provenace in the asset metadata.
     * Create default provenance metadata for publishing an asset.
     * This create a random activity ID for tracking the provenance.
     *
     * @return respective data asset sub class.
     */
    default DataAsset includeProvenace()  {

<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        if (null != this.getMetadata().get(Constant.PROVENANCE) ) {</span>
<span class="nc" id="L142">            return this;</span>

        } else {
<span class="fc" id="L145">            Map&lt;String, Object&gt; metaMap = this.getMetadata();</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">            String  name  =null != metaMap.get(&quot;name&quot;) ?</span>
<span class="pc" id="L147">            metaMap.get(&quot;name&quot;).toString() :&quot;Prov_data_of&quot;;</span>
<span class="fc" id="L148">            metaMap.put(Constant.PROVENANCE,   ProvUtil.createPublishProvenance(name));</span>
<span class="fc" id="L149">            return updateMeta(JSON.toPrettyString(metaMap));</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>