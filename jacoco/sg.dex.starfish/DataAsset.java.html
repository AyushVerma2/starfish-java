<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataAsset.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Starfish - Developer Toolkit for data ecosystems</a> &gt; <a href="index.source.html" class="el_package">sg.dex.starfish</a> &gt; <span class="el_source">DataAsset.java</span></div><h1>DataAsset.java</h1><pre class="source lang-java linenums">package sg.dex.starfish;

import sg.dex.crypto.Hash;
import sg.dex.starfish.constant.Constant;
import sg.dex.starfish.exception.AuthorizationException;
import sg.dex.starfish.exception.StarfishValidationException;
import sg.dex.starfish.exception.StorageException;
import sg.dex.starfish.util.Hex;
import sg.dex.starfish.util.JSON;
import sg.dex.starfish.util.Utils;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Map;

/**
 * Interface representing a data asset.
 *
 * A data asset is any asset that can be represented as an immutable sequence of bytes.
 * As such, data assets offer the following properties:
 * - They can be validated with a hash of the byte content
 * - The byte representation of the data can be obtained (subject to appropriate permissions)
 *
 * @author Mike
 * @version 0.5
 */
public interface DataAsset extends Asset {

	@Override
	public default boolean isDataAsset() {
<span class="nc" id="L32">		return true;</span>
	}

	/**
	 * Gets an input stream that can be used to consume the content of this asset.
	 *
	 * Will throw an exception if consumption of the asset data in not possible locally.
	 * @throws AuthorizationException if requester does not have access permission
	 * @throws StorageException if unable to load the Asset
	 * @return An input stream allowing consumption of the asset data
	 */
	public InputStream getContentStream();

	/**
	 * Gets the data content of this data asset as a byte[] array.
	 *
	 * @return The byte contents of this asset.
	 */
	@Override
	public default byte[] getContent() {
<span class="fc" id="L52">		InputStream is = getContentStream();</span>
<span class="fc" id="L53">		ByteArrayOutputStream buffer = new ByteArrayOutputStream();</span>

<span class="fc" id="L55">		byte[] buf = new byte[16384];</span>

		int bytesRead;
		try {
<span class="fc bfc" id="L59" title="All 2 branches covered.">			while ((bytesRead = is.read(buf, 0, buf.length)) != -1) {</span>
<span class="fc" id="L60">				buffer.write(buf, 0, bytesRead);</span>
			}
<span class="nc" id="L62">		} catch (IOException e) {</span>
<span class="nc" id="L63">			throw new StorageException(&quot;Unable to get Asset content&quot;,e);</span>
<span class="fc" id="L64">		}</span>

<span class="fc" id="L66">		return buffer.toByteArray();</span>
	}

	/**
	 * Gets the size of this data asset's content
	 *
	 * @return The size of the asset in bytes
	 */
	public abstract long getContentSize();


	/**
	 * This method is to validate the hash of the asset content .
	 * it will calculate the hash of the content of an Asset
	 * then compare with the hash value included in metadata,
	 * if both are not the same , StarfishValidation Exception will be thrown
	 * @return boolean  true if the content is valid else false
	 *
	 * @throws StarfishValidationException if hash content is not matched , exception will be thrown
	 */
	public default boolean validateContentHash() {

<span class="fc" id="L88">		Object contentHashFromMetadata =  this.getMetadata().get(Constant.CONTENT_HASH);</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">		if(null == contentHashFromMetadata){</span>
<span class="nc" id="L90">            throw new StarfishValidationException(&quot;Content hash is not included in the metadata&quot;);</span>
        }

<span class="fc" id="L93">            String contentHash = Hex.toString(Hash.sha3_256(Utils.stringFromStream(this.getContentStream())));</span>
<span class="pc bpc" id="L94" title="2 of 4 branches missed.">		if (null != contentHashFromMetadata &amp;&amp; !contentHashFromMetadata.toString().equals(contentHash)) {</span>
<span class="nc" id="L95">			throw new StarfishValidationException(&quot;Failed to validate content hash&quot;);</span>
		}
<span class="fc" id="L97">		return true;</span>
	}

	/**
	 * This method is used to calculate the hash of the content by using keccak256 hashing algorithm.
	 *
	 * @return the content of hash as string
	 */

	public default String getContentHash() {

<span class="fc" id="L108">		return Hex.toString(Hash.sha3_256(this.getContent()));</span>
	}

	/**
	 * This method is to include the content of hash in the asset metadata.
	 * Hash of the content will be calculated based on sha3_256String hashing algo , and the hash content will
	 * be included in the asset metadata.
	 * This hash content will be used to validate the integrity of asset content
	 * Also this operation is only applicable if the Asset is of type DataAsset , if Asset is not
	 * DataAsset Unsupported Operation Exception will be thrown
	 *
	 * @return respective data asset sub class.
	 * @throws UnsupportedOperationException if the Asset type is not DataAsset
	 */
	public default DataAsset includeContentHash() {

		// check if the hash content is already present also
		// validate if content is valid or not
<span class="pc bpc" id="L126" title="3 of 4 branches missed.">		if (null != this.getMetadata().get(Constant.CONTENT_HASH) &amp;&amp; validateContentHash()) {</span>

<span class="nc" id="L128">			return this;</span>
		} else {
<span class="fc" id="L130">			Map&lt;String, Object&gt; metaMap = this.getMetadata();</span>
<span class="fc" id="L131">			metaMap.put(Constant.CONTENT_HASH, getContentHash());</span>

			// this operation is only valid for dataAsset
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">			if (this instanceof DataAsset) {</span>
<span class="fc" id="L135">				return this.updateMeta(JSON.toPrettyString(metaMap));</span>
			} else {
<span class="nc" id="L137">				throw new UnsupportedOperationException(&quot;This method only applicable for Asset type DataAsset&quot;);</span>
			}
		}
	}

	/**
	 * Get the new Data Asset based on metaData passed as n argument.
	 * This method will be implemented by the sub class
	 *
	 * @param newMetaData new meta data that will be used to create a Data Asset.
	 * @return the respective dataAsset based on sub-class
	 * @throws UnsupportedOperationException if this operation  is not supported by sub-class
	 */
	public default DataAsset updateMeta(String newMetaData) {
<span class="nc" id="L151">		throw new UnsupportedOperationException(&quot;This Operation is not supported&quot;);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>